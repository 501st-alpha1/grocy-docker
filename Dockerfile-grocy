FROM php:7.2-fpm-alpine
LABEL maintainer="Talmai Oliveira <to@talm.ai>"

# Optionally authenticate with GitHub using an API token
#
# This can reduce instances of download rate limiting by GitHub
# https://developer.github.com/v3/#rate-limiting
#
# This value is *not* assigned to a variable using the ENV instruction,
# since those variables are persisted in the resulting image and could leak
# developer credentials
# https://docs.docker.com/engine/reference/builder/#env
ARG GITHUB_API_TOKEN

RUN     apk update && \
        apk add --no-cache \
            composer \
            yarn \
            git \
            python \
            py-pip \
            wget \
            freetype \
            libpng \
            libjpeg-turbo \
            freetype-dev \
            libpng-dev \
            libjpeg-turbo-dev && \
        docker-php-ext-configure gd \
            --with-gd \
            --with-freetype-dir=/usr/include/ \
            --with-png-dir=/usr/include/ \
            --with-jpeg-dir=/usr/include/ && \
        NPROC=$(grep -c ^processor /proc/cpuinfo 2>/dev/null || 1) && \
        docker-php-ext-install -j${NPROC} gd && \
    # Set environments
        sed -i "s|;*daemonize\s*=\s*yes|daemonize = no|g" /usr/local/etc/php-fpm.conf && \
        pip install lastversion==0.2.4 && \
        wget --header "Authorization: ${GITHUB_API_TOKEN}" -t 3 -T 30 -nv -O "grocy.tar.gz" $(GITHUB_API_TOKEN=${GITHUB_API_TOKEN} lastversion --source grocy/grocy) && \
        tar xzf grocy.tar.gz && \
        rm -f grocy.tar.gz && \
        cd grocy-* && \
        mv public /var/www/public && \
        mv controllers /var/www/controllers && \
        mv data /var/www/data && \
        mv helpers /var/www/helpers && \
        mv localization/ /var/www/localization && \
        mv middleware/ /var/www/middleware && \
        mv migrations/ /var/www/migrations && \
        mv publication_assets/ /var/www/publication_assets && \
        mv services/ /var/www/services && \
        mv views/ /var/www/views && \
        mv composer.* /var/www/ && \
        mv .yarnrc /var/www/ && \
        mv *.php /var/www/ && \
        mv *.json /var/www/ && \
        mv *yarn* /var/www/ && \
        mv *.sh /var/www/


RUN cd /var/www/html && \
        COMPOSER_OAUTH=${GITHUB_API_TOKEN:+"\"github.com\": \"${GITHUB_API_TOKEN}\""} && \
        COMPOSER_AUTH="{\"github-oauth\": { ${COMPOSER_OAUTH} }}" composer install --no-interaction --no-dev --optimize-autoloader --working-dir=/var/www/ && \
        cp /var/www/config-dist.php /var/www/data/config.php && \
        cd /var/www && \
        yarn install --production && \
        mkdir /var/www/data/viewcache && \
        chown www-data:www-data -R /var/www/

# Set Workdir
WORKDIR /var/www/public

# Expose volumes
VOLUME ["/var/www"]

# Expose ports
EXPOSE 9000
